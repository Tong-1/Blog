<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="keywords" content="welcome"><meta name="descriptioon" content="没事儿,tong-h,Tong-H"><meta name="renderer" content="wekit"><link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/css/public.css"><link rel="stylesheet" href="/css/reset.css"><link rel="stylesheet" href="http://at.alicdn.com/t/font_1200423_cpvgoq4ya9s.css"><title>理解浏览器缓存机制 [ 没事儿 ]</title><link rel="stylesheet" href="/css/partial/sidebar.css"><link rel="stylesheet" href="/css/post.css"></head><body class="scroll"><link rel="stylesheet" href="/css/partial/header.css"><div class="header"><div class="maxwidth"><div class="nav"><a id="artlist" href="/archives"><i class="iconfont iconArchives"></i><span class="headhid">&nbsp;Archives</span></a><a id="artlist" href="/about"><i class="iconfont iconAbout"></i><span class="headhid">&nbsp;About</span></a><a id="artlist" href="/404"><i class="iconfont iconCommonweal"></i><span class="headhid">&nbsp;Commonweal</span></a></div><div class="search">It's more tiring to stop</div></div></div><div class="line"></div><div class="main"> <div class="maxwidth"><link rel="stylesheet" href="/css/partial/sidebar.css"><div id="sidebar"><div class="info"><img src="/images/user.png" alt="头像"><div><p>没事儿</p></div></div><div class="social"><a href="/archives" title="Home"><i class="iconfont iconHome"></i></a><a href="/atom.xml" title="RSS 源订阅"><i class="iconfont iconsubscribe-1-copy"></i></a><a href="mailto:tongt0232@gmail.com" title="E-Mail"><i class="iconfont iconweibiaoti554"></i></a><a href="https://github.com/tong-h" title="GitHub"><i class="iconfont iconGitHub"></i></a><a href="https://www.jianshu.com/u/20de04cc53de" title="简书"><img src="/images/jianicon-sidebar.png"></a></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rests/">rests</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">6</span></li></ul><div class="tags"><a href="/tags/ECharts/" style="font-size: 14px; color: #ffac00">ECharts</a> <a href="/tags/Electron/" style="font-size: 14px; color: #ffac00">Electron</a> <a href="/tags/JSON/" style="font-size: 14px; color: #ffac00">JSON</a> <a href="/tags/angular/" style="font-size: 22px; color: #da8d00">angular</a> <a href="/tags/canvas/" style="font-size: 22px; color: #da8d00">canvas</a> <a href="/tags/cordova/" style="font-size: 30px; color: #b46e00">cordova</a> <a href="/tags/ffmpeg/" style="font-size: 14px; color: #ffac00">ffmpeg</a> <a href="/tags/git/" style="font-size: 14px; color: #ffac00">git</a> <a href="/tags/hexo/" style="font-size: 14px; color: #ffac00">hexo</a> <a href="/tags/http/" style="font-size: 14px; color: #ffac00">http</a> <a href="/tags/markdown/" style="font-size: 14px; color: #ffac00">markdown</a> <a href="/tags/mpvue/" style="font-size: 14px; color: #ffac00">mpvue</a> <a href="/tags/mysql/" style="font-size: 14px; color: #ffac00">mysql</a> <a href="/tags/nginx/" style="font-size: 14px; color: #ffac00">nginx</a> <a href="/tags/nodejs/" style="font-size: 14px; color: #ffac00">nodejs</a> <a href="/tags/npm/" style="font-size: 14px; color: #ffac00">npm</a> <a href="/tags/python/" style="font-size: 14px; color: #ffac00">python</a> <a href="/tags/rests/" style="font-size: 14px; color: #ffac00">rests</a> <a href="/tags/search/" style="font-size: 14px; color: #ffac00">search</a> <a href="/tags/vue/" style="font-size: 14px; color: #ffac00">vue</a> <a href="/tags/原型链/" style="font-size: 14px; color: #ffac00">原型链</a> <a href="/tags/服务器/" style="font-size: 14px; color: #ffac00">服务器</a> <a href="/tags/死磕英语/" style="font-size: 14px; color: #ffac00">死磕英语</a> <a href="/tags/网络爬虫/" style="font-size: 22px; color: #da8d00">网络爬虫</a> <a href="/tags/跨域/" style="font-size: 14px; color: #ffac00">跨域</a></div></div><div class="post rightside"><div class="title">理解浏览器缓存机制</div><div class="info"><i class="iconfont iconshijian1">2019-05-14 11:44</i><i class="iconfont iconshijian1">2019-05-14 17:29</i><i class="iconfont iconshijian1">[object Object]</i><span id="busuanzi_container_site_pv">  <span id="busuanzi_value_site_pv"></span> </span><i class="iconfont iconwenzi">6259</i></div><div class="postDetail"><p>有关浏览器缓存的几个疑问</p>
<ul>
<li>浏览器缓存判断流程？</li>
<li>两种分类协商缓存和强制缓存是什么？怎么判断？</li>
<li>缓存的资源放在哪儿？</li>
<li>不同的刷新对缓存的影响？</li>
</ul>
<h2 id="浏览器缓存的流程"><a href="#浏览器缓存的流程" class="headerlink" title="浏览器缓存的流程"></a>浏览器缓存的流程</h2><p>当客户端请求某个资源，首先需要询问浏览器是否存在缓存<br>有以下三种结果：</p>
<ul>
<li>不存在，那么直接向服务器发起请求，就像第一次访问该网站一样</li>
<li>存在，通过Cache-Control、Expires判断后缓存已失效，那么则使用协商缓存，携带该资源缓存标识向服务器发起请求，服务器根据 http header 判断后决定是否使用缓存，若协商缓存失效重新拉取请求结果则状态码为 200 ，若协商缓存生效那么继续使用缓存状态码为 304</li>
<li>存在，通过Cache-Control、Expires判断后未失效，那么继续使用缓存状态码为 304</li>
</ul>
<p>图示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  浏览器发起请求</span><br><span class="line">        |</span><br><span class="line">        |</span><br><span class="line">    是否有缓存 ——— 是 ——— 缓存是否失效 ——— 是 ——— 协商缓存 ———— 成功</span><br><span class="line">        |                     |                    |           |</span><br><span class="line">        |                     |                    |           |</span><br><span class="line">        否                    否                  失败          |</span><br><span class="line">        |                     |                    |           |</span><br><span class="line">        |—————————————————————|————————————————————|           |</span><br><span class="line">        |                     |                                |</span><br><span class="line">  向服务器请求资源           读取缓存————————————————————————————|</span><br><span class="line">        |                     |</span><br><span class="line">        |                     |</span><br><span class="line">根据 http header 存缓存        |</span><br><span class="line">        |                     |</span><br><span class="line">        |—————————————————————|</span><br><span class="line">        |</span><br><span class="line">     完成加载</span><br></pre></td></tr></table></figure>
<p>所以有两种缓存类型，强制缓存和协商缓存，优先判断的不需要发 http 请求的是强制缓存<br>当强制缓存无效时才启用协商缓存，协商缓存需要发送 http 请求交由服务器判断，可以应用于一些时常需要动态更新的资源文件</p>
<h2 id="强制缓存"><a href="#强制缓存" class="headerlink" title="强制缓存"></a>强制缓存</h2><p>浏览器判断强制缓存是否存在和是否失效这两个：Cache-Control、Expires</p>
<ul>
<li>Cache-Control *</li>
</ul>
<p>http/1.1的字段，控制网页缓存的主要规则，取值：</p>
<ul>
<li>public： 所有内容都将被缓存</li>
<li>private：默认值，所有内容只有客户端可以缓存， CDN 等中继缓存服务器不能缓存</li>
<li>no-cache：客户端缓存内容，但由协商缓存决定是否使用缓存</li>
<li>no-store：所有内容都不会被缓存</li>
<li>max-ag=xxx：缓存内容在xxx秒后失效</li>
<li>max-stale=xxx: 指定时间内，即使缓存过时依然使用资源</li>
<li>min-fresh=xxx：缓存的资源至上要保持指定时间的新鲜期</li>
<li>only-if-cached：仅仅返回已经缓存的资源，不访问网络，无缓存返回 504</li>
<li><p>no-transform：强制要求代理服务器不要对资源进行转换，禁止代理服务器对 Content-Type、Content-Encoding, Content-Range 字段进行修改</p>
</li>
<li><p>Expires *</p>
</li>
</ul>
<p>http/1.0 的字段，请求结果缓存到期时间，优先级低于 Cache-Control:max-age<br>由于 Expires 设置的时绝对时间<br>若 Expires 和 Cache-Control:max-age 两者都没出现浏览器默认使用启发式算法：响应头的（ Date - Last - Modified ）<em> 10，也就是（响应时间 - 文件最后修改时间 ）</em> 10</p>
<h2 id="协商缓存"><a href="#协商缓存" class="headerlink" title="协商缓存"></a>协商缓存</h2><p>Etag / If-None-Match 优先级高于Last-Modified / If-Modfied-Since，同时存在前者生效</p>
<ul>
<li><p>Last-Modified / If-Modified-Since / If-Unmodified-since *</p>
</li>
<li><p>Last-Modified 是服务器响应请求时返回该资源在服务器的最后修改时间</p>
</li>
<li>If-Modified-Since 是客户端再次发起请求时携带上次服务器返回的Last-Modified, 服务器接收到这个时间将与该资源在服务器最后修改的时间进行对比，若服务器修改的时间大于客户端发送的时间，则状态码200重新返回资源，否则返回304表示资源无更新继续使用缓存</li>
<li><p>If-Unmodified-since 同上，资源未修改正常执行更新反之返回412</p>
</li>
<li><p>Etag / If-None-Match *</p>
</li>
<li><p>Etag 是资源唯一标识符，服务器响应请求时返回当前资源的唯一标识符</p>
</li>
<li>If-None-Match 是客户端再次发起该请求时携带上次请求时服务器返回的唯一标识符 Etag，服务器接收到该值会与该资源在服务器的 Etag 值做对比，一致状态码 304 表示无更新继续使用缓存，反之则返回资源文件状态码 200</li>
</ul>
<h2 id="缓存的资源在哪儿？"><a href="#缓存的资源在哪儿？" class="headerlink" title="缓存的资源在哪儿？"></a>缓存的资源在哪儿？</h2><p>浏览器通过 http 请求获取到资源，那么资源会缓存在哪儿</p>
<p>memory cache：内存缓存，会将编译解析的文件，直接存入该进程内存中，占据一定的内存资源，以便下次快速读取，进程关闭即清空</p>
<p>from disk cache：硬盘缓存，盘缓存是将缓存写入硬盘文件中，读取缓存需要对该缓存存放的硬盘文件进行i/o操作，然后解析读取，速度比内存缓存慢</p>
<p>浏览器读取缓存时 memory ——&gt; disk ——&gt; 两者都没有便发起网络请求 ——&gt; 获取资源缓存到硬盘和内存</p>
<p>在浏览器中，css 文件会存入硬盘文件中，因为 css 文件通常只在页面渲染时加载一次，<br>而 js 和图片等文件解析执行后直接存入内存缓存中，是因为可能会频繁读取，当刷新页面时只需直接从内存缓存中读取</p>
<h2 id="浏览器行为对缓存的影响"><a href="#浏览器行为对缓存的影响" class="headerlink" title="浏览器行为对缓存的影响"></a>浏览器行为对缓存的影响</h2><ul>
<li>刷新网页，如果缓存没有失效，浏览器直接使用缓存，反之 http 请求数据</li>
<li>手动刷新 / F5，浏览器会认为缓存失效，在请求服务器时加上Cache-Control: max-age=0字段，然后询问服务器数据是否更新</li>
<li>强制刷新 / Ctrl + F5，浏览器会直接忽略缓存，在请求服务器时加上Cache-Control: no-cache字段，然后重新向服务器拉取文件</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li><p>其他和缓存相关的 header 头部 *</p>
</li>
<li><p>date 响应生成时间</p>
</li>
<li>age 代理服务器生成，表示代理服务器对于请求资源的已缓存时间, 单位为秒</li>
<li>Pragma：no-cache: http / 1.0 作用和 Cache-Control:no-cache 一样，如果在控制台勾选 Disable cache, 浏览器自动带上该字段</li>
<li><p>vary 缓存版本，可用于区分 pc 和 移动端需要加载的资源</p>
</li>
<li><p>浏览器禁用缓存 *</p>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Cache-Control"</span> <span class="attr">content</span>=<span class="string">"no-cache, no-store, must-revalidate"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://mp.weixin.qq.com/s?__biz=MjM5MTA1MjAxMQ==&amp;mid=2651226262&amp;idx=1&amp;sn=2128db200b88479face67ed8e095757c&amp;chksm=bd4959128a3ed0041b43a5683c75c4b88c7d35fac909a59c14b4e9fc11e8d408680b171d2706&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">浏览器的缓存机制小结</a><br><a href="https://mp.weixin.qq.com/s/d2zeGhUptGUGJpB5xHQbOA" target="_blank" rel="noopener">彻底理解浏览器的缓存机制</a><br>[]</p>
</div></div></div></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>var _hmt = _hmt || [];(function(){var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?a4d08c5088ca0d4b18c14260c9ca89a1";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})()</script></body></html>